<script>
// Vari√°veis globais
let userData = null;

// Inicializa√ß√£o quando o documento estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            carregarDadosUsuario();
    configurarEventListeners();
});

// Configurar event listeners
function configurarEventListeners() {
    // Form de perfil
    const formPerfil = document.getElementById('formPerfil');
    if (formPerfil) {
        formPerfil.addEventListener('submit', salvarPerfil);
    }
    
    // Upload de foto
    const profilePictureInput = document.getElementById('profilePictureInput');
    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', handleProfilePictureUpload);
    }
    
    // Clique na foto para upload
    const profilePictureContainer = document.querySelector('.profile-picture-container');
    if (profilePictureContainer) {
        profilePictureContainer.addEventListener('click', () => {
            document.getElementById('profilePictureInput').click();
        });
    }
}

// Carregar dados do usu√°rio
async function carregarDadosUsuario() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // Buscar dados b√°sicos do usu√°rio
        const userResponse = await fetch('http://localhost:3002/api/users/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!userResponse.ok) {
            throw new Error('Erro ao carregar dados do usu√°rio');
        }

        userData = await userResponse.json();
        
        // Buscar estat√≠sticas completas
        const statsResponse = await fetch('http://localhost:3002/api/stats/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            // Combinar dados do usu√°rio com estat√≠sticas
            userData = { ...userData, ...stats };
        }

        preencherFormularioPerfil(userData);
        carregarFotoPerfil(userData.profile_picture_url);
        atualizarEstatisticas(userData);

    } catch (error) {
        console.error('Erro ao carregar dados do usu√°rio:', error);
        alert('Erro ao carregar dados do usu√°rio. Tente novamente.');
    }
}

// Preencher formul√°rio com dados do usu√°rio
function preencherFormularioPerfil(user) {
    document.getElementById('nome').value = user.nome || '';
    document.getElementById('email').value = user.email || '';
}

// Carregar foto de perfil
function carregarFotoPerfil(profilePictureUrl) {
    const profilePicture = document.getElementById('profilePicture');
    if (profilePictureUrl) {
        profilePicture.src = `http://localhost:3002${profilePictureUrl}`;
                } else {
        profilePicture.src = '/uploads/default-avatar.png';
    }
}

// Atualizar estat√≠sticas
function atualizarEstatisticas(user) {
    // Atualizar XP
    const xpElement = document.getElementById('xp-valor');
    if (xpElement) {
        xpElement.textContent = user.xp || 0;
    }
    
    // Atualizar patente
    atualizarPatente(user.patente);
    
    // Atualizar outras estat√≠sticas se existirem
    const questoesRespondidas = document.getElementById('questoesRespondidas');
    if (questoesRespondidas) {
        questoesRespondidas.textContent = user.questoes_respondidas || 0;
    }
    
    const xpTotal = document.getElementById('xpTotal');
    if (xpTotal) {
        xpTotal.textContent = user.xp || 0;
    }
    
    const patenteAtual = document.getElementById('patenteAtual');
    if (patenteAtual) {
        patenteAtual.textContent = user.patente ? user.patente.nome : 'Iniciante';
    }
    
    if (user.ultimo_login) {
        const ultimoLogin = new Date(user.ultimo_login);
        const ultimoLoginElement = document.getElementById('ultimoLogin');
        if (ultimoLoginElement) {
            ultimoLoginElement.textContent = ultimoLogin.toLocaleDateString('pt-BR');
        }
    } else {
        const ultimoLoginElement = document.getElementById('ultimoLogin');
        if (ultimoLoginElement) {
            ultimoLoginElement.textContent = 'Nunca';
        }
    }
}

// Atualizar informa√ß√µes da patente
function atualizarPatente(patente) {
    const patenteIcone = document.getElementById('patente-icone');
    const patenteNome = document.getElementById('patente-nome');
    const patenteDescricao = document.getElementById('patente-descricao');
    
    if (patenteIcone && patenteNome && patenteDescricao) {
        if (patente) {
            patenteIcone.textContent = patente.icone || 'üåü';
            patenteNome.textContent = patente.nome || 'Iniciante';
            patenteDescricao.textContent = patente.descricao || 'Primeiros passos';
        } else {
            patenteIcone.textContent = 'üåü';
            patenteNome.textContent = 'Iniciante';
            patenteDescricao.textContent = 'Primeiros passos';
        }
    }
}

// Calcular patente baseada no XP
function calcularPatente(xp) {
    if (xp >= 1000) return 'Mestre';
    if (xp >= 500) return 'Especialista';
    if (xp >= 200) return 'Avan√ßado';
    if (xp >= 50) return 'Intermedi√°rio';
    return 'Iniciante';
}

// Salvar perfil
async function salvarPerfil(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const novaSenha = formData.get('novaSenha');
    const confirmarSenha = formData.get('confirmarSenha');
    
    // Validar senhas
    if (novaSenha && novaSenha !== confirmarSenha) {
        alert('As senhas n√£o coincidem!');
                return;
            }
            
    try {
        const token = localStorage.getItem('token');
        const dadosAtualizacao = {
            nome: formData.get('nome')
        };
        
        if (novaSenha) {
            dadosAtualizacao.senha = novaSenha;
        }
        
        const response = await fetch('http://localhost:3002/api/users/me', {
                method: 'PUT',
                headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(dadosAtualizacao)
        });
        
        if (!response.ok) {
            throw new Error('Erro ao atualizar perfil');
        }
        
        const resultado = await response.json();
        alert('Perfil atualizado com sucesso!');
        
        // Recarregar dados do usu√°rio
        await carregarDadosUsuario();
        
    } catch (error) {
        console.error('Erro ao salvar perfil:', error);
        alert('Erro ao salvar perfil. Tente novamente.');
    }
}

// Manipular upload de foto de perfil
async function handleProfilePictureUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validar tipo de arquivo
    if (!file.type.startsWith('image/')) {
        alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }
            
    // Validar tamanho (5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('O arquivo deve ter no m√°ximo 5MB.');
                return;
            }
            
    try {
        const formData = new FormData();
        formData.append('profile_picture', file);
        
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:3002/api/upload/profile-picture', {
            method: 'POST',
                headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('Erro ao fazer upload da foto');
        }
        
        const resultado = await response.json();
        alert('Foto de perfil atualizada com sucesso!');
        
        // Atualizar imagem
        carregarFotoPerfil(resultado.profile_picture_url);
        
        // Limpar input
        event.target.value = '';
        
    } catch (error) {
        console.error('Erro ao fazer upload da foto:', error);
        alert('Erro ao fazer upload da foto. Tente novamente.');
    }
}

// Remover foto de perfil
async function removerFotoPerfil() {
    if (!confirm('Tem certeza que deseja remover sua foto de perfil?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:3002/api/upload/profile-picture', {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Erro ao remover foto');
        }
        
        alert('Foto de perfil removida com sucesso!');
        
        // Atualizar imagem
        carregarFotoPerfil(null);
        
    } catch (error) {
        console.error('Erro ao remover foto:', error);
        alert('Erro ao remover foto. Tente novamente.');
    }
}

// Salvar configura√ß√µes
function salvarConfiguracoes() {
    const configuracoes = {
        notificacoes: {
            email: document.getElementById('notifEmail').checked,
            push: document.getElementById('notifPush').checked,
            lembretes: document.getElementById('notifLembretes').checked
        },
        preferencias: {
            tema: document.getElementById('tema').value,
            questoesPorPagina: document.getElementById('questoesPorPagina').value
        }
    };
    
    // Salvar no localStorage
    localStorage.setItem('userConfig', JSON.stringify(configuracoes));
    
    alert('Configura√ß√µes salvas com sucesso!');
}

// Resetar configura√ß√µes
function resetarConfiguracoes() {
    if (!confirm('Tem certeza que deseja restaurar as configura√ß√µes padr√£o?')) {
        return;
    }
    
    // Configura√ß√µes padr√£o
    document.getElementById('notifEmail').checked = true;
    document.getElementById('notifPush').checked = true;
    document.getElementById('notifLembretes').checked = false;
    document.getElementById('tema').value = 'auto';
    document.getElementById('questoesPorPagina').value = '10';
    
    // Remover do localStorage
    localStorage.removeItem('userConfig');
    
    alert('Configura√ß√µes restauradas para os valores padr√£o!');
}

// Carregar configura√ß√µes salvas
function carregarConfiguracoes() {
    const configSalva = localStorage.getItem('userConfig');
    if (configSalva) {
        const config = JSON.parse(configSalva);
        
        if (config.notificacoes) {
            document.getElementById('notifEmail').checked = config.notificacoes.email;
            document.getElementById('notifPush').checked = config.notificacoes.push;
            document.getElementById('notifLembretes').checked = config.notificacoes.lembretes;
        }
        
        if (config.preferencias) {
            document.getElementById('tema').value = config.preferencias.tema;
            document.getElementById('questoesPorPagina').value = config.preferencias.questoesPorPagina;
        }
    }
}

// Aplicar tema
function aplicarTema(tema) {
    const body = document.body;
    
    // Remover classes de tema anteriores
    body.classList.remove('theme-light', 'theme-dark');
    
    if (tema === 'dark') {
        body.classList.add('theme-dark');
    } else if (tema === 'light') {
        body.classList.add('theme-light');
    }
    // 'auto' usa as prefer√™ncias do sistema
}

// Fun√ß√£o para sair
function sair() {
    if (confirm('Tem certeza que deseja sair?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userData');
        window.location.href = '/login';
    }
}

// Carregar configura√ß√µes ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    carregarConfiguracoes();
    
    // Aplicar tema salvo
    const temaSalvo = document.getElementById('tema').value;
    aplicarTema(temaSalvo);
    
    // Listener para mudan√ßa de tema
    document.getElementById('tema').addEventListener('change', function() {
        aplicarTema(this.value);
    });
});
</script>