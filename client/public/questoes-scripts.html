<script>
        // Dados mock das quest√µes
        const questoes = [
            {
                id: 1,
                enunciado: "De acordo com a Constitui√ß√£o Federal de 1988, os direitos e garantias fundamentais s√£o:",
                alternativas: {
                    A: "Apenas os direitos civis e pol√≠ticos",
                    B: "Apenas os direitos sociais e econ√¥micos",
                    C: "Os direitos civis, pol√≠ticos, sociais e econ√¥micos",
                    D: "Apenas os direitos individuais",
                    E: "Apenas os direitos coletivos"
                },
                gabarito: "C",
                disciplina: "Direito Constitucional",
                assunto: "Direitos e Garantias Fundamentais",
                banca: "CESPE",
                orgao: "Pol√≠cia Federal",
                ano: 2023,
                comentario: "A Constitui√ß√£o Federal de 1988 estabelece que os direitos e garantias fundamentais abrangem tanto os direitos civis e pol√≠ticos quanto os direitos sociais e econ√¥micos, formando um sistema integrado de prote√ß√£o √† dignidade da pessoa humana."
            },
            {
                id: 2,
                enunciado: "Qual √© a capital do Brasil?",
                alternativas: {
                    A: "S√£o Paulo",
                    B: "Rio de Janeiro",
                    C: "Bras√≠lia",
                    D: "Salvador",
                    E: "Belo Horizonte"
                },
                gabarito: "C",
                disciplina: "Geografia",
                assunto: "Geografia do Brasil",
                banca: "FGV",
                orgao: "Receita Federal",
                ano: 2022,
                comentario: "Bras√≠lia foi fundada em 1960 para ser a capital do Brasil, substituindo o Rio de Janeiro. A cidade foi planejada pelo arquiteto Oscar Niemeyer e pelo urbanista L√∫cio Costa."
            },
            {
                id: 3,
                enunciado: "Quem escreveu 'Os Lus√≠adas'?",
                alternativas: {
                    A: "Camo√µes",
                    B: "Fernando Pessoa",
                    C: "E√ßa de Queir√≥s",
                    D: "Machado de Assis",
                    E: "Jos√© de Alencar"
                },
                gabarito: "A",
                disciplina: "Portugu√™s",
                assunto: "Literatura Portuguesa",
                banca: "VUNESP",
                orgao: "Tribunal de Justi√ßa",
                ano: 2021,
                comentario: "Lu√≠s Vaz de Cam√µes √© o autor de 'Os Lus√≠adas', poema √©pico portugu√™s publicado em 1572, considerado a obra-prima da literatura portuguesa."
            },
            {
                id: 4,
                enunciado: "Qual √© a raiz quadrada de 144?",
                alternativas: {
                    A: "10",
                    B: "11",
                    C: "12",
                    D: "13",
                    E: "14"
                },
                gabarito: "C",
                disciplina: "Matem√°tica",
                assunto: "√Ålgebra",
                banca: "FCC",
                orgao: "Banco Central",
                ano: 2020,
                comentario: "12 x 12 = 144, portanto a raiz quadrada de 144 √© 12. Esta √© uma opera√ß√£o fundamental em matem√°tica."
            },
            {
                id: 5,
                enunciado: "Em que ano o Brasil se tornou independente de Portugal?",
                alternativas: {
                    A: "1808",
                    B: "1822",
                    C: "1889",
                    D: "1891",
                    E: "1930"
                },
                gabarito: "B",
                disciplina: "Hist√≥ria",
                assunto: "Hist√≥ria do Brasil",
                banca: "IBFC",
                orgao: "Minist√©rio P√∫blico",
                ano: 2024,
                comentario: "O Brasil se tornou independente de Portugal em 7 de setembro de 1822, quando D. Pedro I proclamou a independ√™ncia √†s margens do Rio Ipiranga, em S√£o Paulo."
            }
        ];

        // Estado da aplica√ß√£o
        let questaoAtual = 0;
        let alternativaSelecionada = null;
        let questaoRespondida = false;
        let questoesRespondidas = 0;
        
        // Estado para coment√°rios e avalia√ß√µes
        let comentarios = [];
        let comentariosPagina = 1;
        let comentariosTotal = 0;
        let avaliacaoAtual = null;
        let avaliacaoSelecionada = 0;
        let avaliacaoStats = null;
        let userXP = 150;
        let userStatus = 'gratuito'; // ou 'premium'

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            carregarQuestao();
            atualizarXP();
        });

        // Fun√ß√£o para carregar uma quest√£o
        async function carregarQuestao() {
            const questao = questoes[questaoAtual];
            
            document.getElementById('questaoId').textContent = `Quest√£o #${questao.id}`;
            document.getElementById('questaoDisciplina').textContent = questao.disciplina;
            document.getElementById('questaoBanca').textContent = questao.banca;
            document.getElementById('questaoAno').textContent = questao.ano;
            document.getElementById('questaoEnunciado').textContent = questao.enunciado;
            
            // Carregar alternativas
            const alternativasDiv = document.getElementById('alternativas');
            alternativasDiv.innerHTML = '';
            
            Object.entries(questao.alternativas).forEach(([letra, texto]) => {
                const alternativa = document.createElement('div');
                alternativa.className = 'alternativa';
                alternativa.onclick = () => selecionarAlternativa(letra);
                alternativa.innerHTML = `
                    <div class="alternativa-letra">${letra}</div>
                    <div class="alternativa-texto">${texto}</div>
                `;
                alternativasDiv.appendChild(alternativa);
            });
            
            // Resetar estado
            alternativaSelecionada = null;
            questaoRespondida = false;
            document.getElementById('btnResponder').disabled = true;
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('comentarios').style.display = 'none';
            
            // Verificar se j√° respondeu esta quest√£o
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3002/api/questions/${questao.id}/resposta`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.resposta) {
                        // Mostrar √≠cone de acerto/erro
                        const statusIcon = document.createElement('div');
                        statusIcon.className = 'status-icon';
                        statusIcon.innerHTML = data.resposta.acertou ? '‚úîÔ∏è' : '‚ùå';
                        statusIcon.style.cssText = `
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            font-size: 1.5rem;
                            color: ${data.resposta.acertou ? '#28a745' : '#dc3545'};
                        `;
                        document.querySelector('.questao-container').appendChild(statusIcon);
                        
                        // Marcar alternativa selecionada
                        alternativaSelecionada = data.resposta.alternativa_marcada;
                        const alternativaIndex = data.resposta.alternativa_marcada.charCodeAt(0) - 65;
                        const alternativa = document.querySelector(`.alternativa:nth-child(${alternativaIndex + 1})`);
                        if (alternativa) {
                            alternativa.classList.add('selecionada');
                        }
                        
                        // Mostrar resultado
                        const feedback = document.getElementById('feedback');
                        feedback.style.display = 'block';
                        feedback.className = `feedback ${data.resposta.acertou ? 'acerto' : 'erro'}`;
                        
                        if (data.resposta.acertou) {
                            feedback.innerHTML = `
                                <h3>üéâ Voc√™ acertou esta quest√£o!</h3>
                                <p>Resposta correta: <strong>${questao.gabarito}</strong></p>
                            `;
                        } else {
                            feedback.innerHTML = `
                                <h3>‚ùå Voc√™ errou esta quest√£o</h3>
                                <p>Sua resposta: <strong>${data.resposta.alternativa_marcada}</strong></p>
                                <p>Resposta correta: <strong>${questao.gabarito}</strong></p>
                            `;
                        }
                        
                        // Marcar alternativas
                        document.querySelectorAll('.alternativa').forEach((alt, index) => {
                            const letra = String.fromCharCode(65 + index);
                            if (letra === questao.gabarito) {
                                alt.classList.add('correta');
                            } else if (letra === data.resposta.alternativa_marcada && !data.resposta.acertou) {
                                alt.classList.add('incorreta');
                            }
                        });
                        
                        // Mostrar coment√°rios
                        document.getElementById('comentarios').style.display = 'block';
                        document.getElementById('comentarioProfessor').textContent = questao.comentario;
                        
                        // Carregar coment√°rios e avalia√ß√µes
                        await carregarComentarios();
                        await carregarAvaliacao();
                        
                        // Atualizar bot√£o
                        document.getElementById('btnResponder').disabled = false;
                        document.getElementById('btnResponder').textContent = 'Refazer Quest√£o';
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar resposta:', error);
            }
            
            // Atualizar pagina√ß√£o
            document.getElementById('paginaAtual').textContent = questaoAtual + 1;
            document.getElementById('btnAnterior').disabled = questaoAtual === 0;
            document.getElementById('btnProxima').disabled = questaoAtual === questoes.length - 1;
        }

        // Fun√ß√£o para selecionar alternativa
        function selecionarAlternativa(letra) {
            if (questaoRespondida) return;
            
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.alternativa').forEach(alt => {
                alt.classList.remove('selecionada');
            });
            
            // Selecionar nova alternativa
            const alternativa = document.querySelector(`.alternativa:nth-child(${letra.charCodeAt(0) - 64})`);
            alternativa.classList.add('selecionada');
            alternativaSelecionada = letra;
            
            document.getElementById('btnResponder').disabled = false;
        }

        // Fun√ß√£o para responder quest√£o
        async function responderQuestao() {
            if (!alternativaSelecionada) return;
            
            const questao = questoes[questaoAtual];
            
            try {
                // Fazer requisi√ß√£o para a API
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3002/api/questions/${questao.id}/responder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        alternativa_marcada: alternativaSelecionada,
                        tempo_resposta: 30 // Simular tempo de resposta
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (data.upgradeRequired) {
                        alert('Voc√™ atingiu o limite de quest√µes gratuitas. Fa√ßa upgrade para Premium!');
                        return;
                    }
                    throw new Error(data.message || 'Erro ao responder quest√£o');
                }

                const acertou = data.acertou;
                const xpGanho = data.xpGanho || 0;
                
                // Mostrar feedback
                const feedback = document.getElementById('feedback');
                feedback.style.display = 'block';
                feedback.className = `feedback ${acertou ? 'acerto' : 'erro'}`;
                
                if (acertou) {
                    feedback.innerHTML = `
                        <h3>üéâ Parab√©ns! Voc√™ acertou!</h3>
                        <p>A alternativa correta √©: <strong>${data.gabarito}</strong></p>
                        <div class="xp-gain">+${xpGanho} XP</div>
                    `;
                } else {
                    feedback.innerHTML = `
                        <h3>‚ùå Que pena! Voc√™ errou.</h3>
                        <p>Sua resposta: <strong>${alternativaSelecionada}</strong></p>
                        <p>Resposta correta: <strong>${data.gabarito}</strong></p>
                    `;
                }
                
                // Marcar alternativas
                document.querySelectorAll('.alternativa').forEach((alt, index) => {
                    const letra = String.fromCharCode(65 + index);
                    if (letra === data.gabarito) {
                        alt.classList.add('correta');
                    } else if (letra === alternativaSelecionada && !acertou) {
                        alt.classList.add('incorreta');
                    }
                });
                
                // Atualizar estado
                questaoRespondida = true;
                questoesRespondidas++;
                userXP += xpGanho;
                atualizarXP();
                
                // Mostrar coment√°rios
                setTimeout(async () => {
                    document.getElementById('comentarios').style.display = 'block';
                    document.getElementById('comentarioProfessor').textContent = questao.comentario;
                    
                    // Carregar coment√°rios e avalia√ß√µes
                    await carregarComentarios();
                    await carregarAvaliacao();
                }, 1000);
                
                // Habilitar bot√£o para refazer (n√£o desabilitar mais)
                document.getElementById('btnResponder').disabled = false;
                document.getElementById('btnResponder').textContent = 'Refazer Quest√£o';
                
            } catch (error) {
                console.error('Erro ao responder quest√£o:', error);
                alert('Erro ao responder quest√£o. Tente novamente.');
            }
        }

        // Fun√ß√£o para mudar quest√£o
        async function mudarQuestao(direcao) {
            const novaQuestao = questaoAtual + direcao;
            if (novaQuestao >= 0 && novaQuestao < questoes.length) {
                questaoAtual = novaQuestao;
                await carregarQuestao();
            }
        }

        // Fun√ß√£o para filtrar quest√µes
        function filtrarQuestoes() {
            carregarQuestoes();
        }
        
        // Fun√ß√£o para limpar filtros
        function limparFiltros() {
            document.getElementById('disciplina').value = '';
            document.getElementById('assunto').value = '';
            document.getElementById('banca').value = '';
            document.getElementById('orgao').value = '';
            document.getElementById('ano').value = '';
            document.getElementById('statusResposta').value = '';
            document.getElementById('ocultarRespondidas').checked = false;
            
            // Limpar op√ß√µes de assunto
            const assuntoSelect = document.getElementById('assunto');
            assuntoSelect.innerHTML = '<option value="">Todos os assuntos</option>';
            
            // Recarregar quest√µes
            carregarQuestoes();
        }

        // Fun√ß√£o para filtrar assuntos baseado na disciplina
        async function filtrarAssuntos() {
            const disciplinaId = document.getElementById('disciplina').value;
            const assuntoSelect = document.getElementById('assunto');
            
            // Limpar op√ß√µes
            assuntoSelect.innerHTML = '<option value="">Todos os assuntos</option>';
            
            if (disciplinaId) {
                try {
                    const response = await fetch(`http://localhost:3002/api/categories/assuntos/${disciplinaId}`);
                    if (!response.ok) throw new Error('Erro ao carregar assuntos');
                    
                    const data = await response.json();
                    data.assuntos.forEach(assunto => {
                        const option = document.createElement('option');
                        option.value = assunto.id;
                        option.textContent = assunto.nome;
                        assuntoSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Erro ao carregar assuntos:', error);
                }
            }
        }

        // Fun√ß√£o para atualizar XP
        function atualizarXP() {
            const xpElement = document.getElementById('userXP');
            if (xpElement) {
                xpElement.textContent = userXP;
            }
            
            // Atualizar patente baseada no XP
            atualizarPatente(userXP);
        }
        
        // Fun√ß√£o para atualizar patente
        function atualizarPatente(xp) {
            const patenteElement = document.getElementById('userPatente');
            if (patenteElement) {
                let patente = 'Iniciante';
                let icone = 'üåü';
                
                if (xp >= 2000) {
                    patente = 'Lenda';
                    icone = 'üíé';
                } else if (xp >= 1000) {
                    patente = 'Mestre';
                    icone = 'üëë';
                } else if (xp >= 500) {
                    patente = 'Destacado';
                    icone = '‚≠ê';
                } else if (xp >= 300) {
                    patente = 'Esfor√ßado';
                    icone = 'üî•';
                } else if (xp >= 150) {
                    patente = 'Aplicado';
                    icone = 'üéØ';
                } else if (xp >= 50) {
                    patente = 'Estudante';
                    icone = 'üìö';
                }
                
                patenteElement.innerHTML = `${icone} ${patente}`;
            }
        }

        // Fun√ß√£o para carregar coment√°rios dos alunos
        function carregarComentariosAlunos() {
            const comentarios = [
                { nome: 'Maria Silva', data: '12/08/2024', texto: 'Excelente explica√ß√£o! Muito clara.' },
                { nome: 'Jo√£o Santos', data: '11/08/2024', texto: 'Essa quest√£o sempre me confunde, obrigado pelo coment√°rio!' }
            ];
            
            const listaComentarios = document.getElementById('listaComentarios');
            listaComentarios.innerHTML = '';
            
            comentarios.forEach(comentario => {
                const div = document.createElement('div');
                div.className = 'comentario-aluno';
                div.innerHTML = `
                    <div class="comentario-header">
                        <span>${comentario.nome}</span>
                        <span>${comentario.data}</span>
                    </div>
                    <div>${comentario.texto}</div>
                `;
                listaComentarios.appendChild(div);
            });
        }

        // Fun√ß√£o para adicionar coment√°rio
        function adicionarComentario() {
            const texto = document.getElementById('novoComentario').value.trim();
            if (!texto) return;
            
            const comentario = {
                nome: 'Voc√™',
                data: new Date().toLocaleDateString('pt-BR'),
                texto: texto
            };
            
            const listaComentarios = document.getElementById('listaComentarios');
            const div = document.createElement('div');
            div.className = 'comentario-aluno';
            div.innerHTML = `
                <div class="comentario-header">
                    <span>${comentario.nome}</span>
                    <span>${comentario.data}</span>
                </div>
                <div>${comentario.texto}</div>
            `;
            listaComentarios.appendChild(div);
            
            document.getElementById('novoComentario').value = '';
        }

        // Fun√ß√£o para carregar quest√µes da API
        async function carregarQuestoes() {
            if (carregando) return;
            
            carregando = true;
            mostrarCarregando(true);
            
            try {
                // Coletar filtros
                const disciplinaId = document.getElementById('disciplina').value;
                const assuntoId = document.getElementById('assunto').value;
                const bancaId = document.getElementById('banca').value;
                const orgaoId = document.getElementById('orgao').value;
                const ano = document.getElementById('ano').value;
                const statusResposta = document.getElementById('statusResposta').value;
                const ocultarRespondidas = document.getElementById('ocultarRespondidas').checked;
                
                // Construir URL com filtros
                const params = new URLSearchParams();
                if (disciplinaId) params.append('disciplina_id', disciplinaId);
                if (assuntoId) params.append('assunto_id', assuntoId);
                if (bancaId) params.append('banca_id', bancaId);
                if (orgaoId) params.append('orgao_id', orgaoId);
                if (ano) params.append('ano', ano);
                if (statusResposta) params.append('status_resposta', statusResposta);
                if (ocultarRespondidas) params.append('ocultar_respondidas', 'true');
                
                const token = localStorage.getItem('token');
                const url = `http://localhost:3002/api/questions?${params.toString()}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar quest√µes');
                
                const data = await response.json();
                questoes = data.questoes || [];
                
                // Resetar estado
                questaoAtual = 0;
                alternativaSelecionada = null;
                questaoRespondida = false;
                
                // Carregar primeira quest√£o
                if (questoes.length > 0) {
                    await carregarQuestao();
                } else {
                    document.getElementById('questaoContainer').innerHTML = '<p>Nenhuma quest√£o encontrada com os filtros selecionados.</p>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar quest√µes:', error);
                document.getElementById('questaoContainer').innerHTML = '<p>Erro ao carregar quest√µes. Tente novamente.</p>';
            } finally {
                carregando = false;
                mostrarCarregando(false);
            }
        }

        // Fun√ß√£o para mostrar/ocultar carregamento
        function mostrarCarregando(mostrar) {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = mostrar ? 'block' : 'none';
            }
        }

        // ===== FUN√á√ïES PARA COMENT√ÅRIOS =====

        // Carregar coment√°rios da quest√£o atual
        async function carregarComentarios() {
            if (!questoes[questaoAtual]) return;
            
            try {
                const questaoId = questoes[questaoAtual].id;
                const token = localStorage.getItem('token');
                const url = `http://localhost:3002/api/comentarios?questao_id=${questaoId}&page=${comentariosPagina}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar coment√°rios');
                
                const data = await response.json();
                comentarios = data.comentarios || [];
                comentariosTotal = data.total;
                
                renderizarComentarios();
                renderizarPaginacaoComentarios();
                
            } catch (error) {
                console.error('Erro ao carregar coment√°rios:', error);
            }
        }

        // Renderizar lista de coment√°rios
        function renderizarComentarios() {
            const container = document.getElementById('listaComentarios');
            if (!container) return;
            
            if (comentarios.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum coment√°rio ainda. Seja o primeiro a comentar!</p>';
                return;
            }
            
            container.innerHTML = comentarios.map(comentario => `
                <div class="comentario-item">
                    <div class="comentario-header">
                        <div class="comentario-usuario">
                            <div class="comentario-avatar">
                                ${comentario.usuario.nome.charAt(0).toUpperCase()}
                            </div>
                            <div class="comentario-info">
                                <div class="comentario-nome">${comentario.usuario.nome}</div>
                                <div class="comentario-meta">${new Date(comentario.data_criacao).toLocaleDateString('pt-BR')}</div>
                            </div>
                        </div>
                        <span class="comentario-tipo ${comentario.tipo.toLowerCase()}">${comentario.tipo}</span>
                    </div>
                    <div class="comentario-texto">${comentario.texto}</div>
                    <div class="comentario-actions">
                        <div class="comentario-likes">
                            <button class="like-button" onclick="darLike(${comentario.id})">
                                üëç ${comentario.likes || 0}
                            </button>
                        </div>
                        ${comentario.respondido ? `
                            <div class="resposta-admin">
                                <div class="resposta-admin-header">Resposta do Administrador:</div>
                                <div class="resposta-admin-texto">${comentario.resposta_admin}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Renderizar pagina√ß√£o de coment√°rios
        function renderizarPaginacaoComentarios() {
            const container = document.getElementById('comentariosPaginacao');
            if (!container) return;
            
            const totalPages = Math.ceil(comentariosTotal / 10);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginacao = '';
            for (let i = 1; i <= totalPages; i++) {
                paginacao += `
                    <button class="${i === comentariosPagina ? 'active' : ''}" 
                            onclick="mudarPaginaComentarios(${i})">${i}</button>
                `;
            }
            container.innerHTML = paginacao;
        }

        // Mudar p√°gina de coment√°rios
        function mudarPaginaComentarios(pagina) {
            comentariosPagina = pagina;
            carregarComentarios();
        }

        // Filtrar coment√°rios por tipo
        function filtrarComentarios() {
            comentariosPagina = 1;
            carregarComentarios();
        }

        // Adicionar novo coment√°rio
        async function adicionarComentario() {
            const texto = document.getElementById('novoComentario').value.trim();
            const tipo = document.getElementById('tipoComentario').value;
            
            if (!texto || !tipo) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            if (!questoes[questaoAtual]) return;
            
            try {
                const questaoId = questoes[questaoAtual].id;
                const token = localStorage.getItem('token');
                
                const response = await fetch('http://localhost:3002/api/comentarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        questao_id: questaoId,
                        texto: texto,
                        tipo: tipo
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao adicionar coment√°rio');
                }
                
                const result = await response.json();
                alert(result.message);
                
                // Limpar formul√°rio
                document.getElementById('novoComentario').value = '';
                document.getElementById('tipoComentario').value = '';
                document.getElementById('charCount').textContent = '0/1000';
                
                // Recarregar coment√°rios
                comentariosPagina = 1;
                await carregarComentarios();
                
            } catch (error) {
                console.error('Erro ao adicionar coment√°rio:', error);
                alert('Erro ao adicionar coment√°rio: ' + error.message);
            }
        }

        // Dar like em coment√°rio
        async function darLike(comentarioId) {
            try {
                const token = localStorage.getItem('token');
                
                const response = await fetch(`http://localhost:3002/api/comentarios/${comentarioId}/like`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao dar like');
                
                // Recarregar coment√°rios para atualizar likes
                await carregarComentarios();
                
            } catch (error) {
                console.error('Erro ao dar like:', error);
            }
        }

        // ===== FUN√á√ïES PARA AVALIA√á√ïES =====

        // Carregar avalia√ß√£o da quest√£o atual
        async function carregarAvaliacao() {
            if (!questoes[questaoAtual]) return;
            
            try {
                const questaoId = questoes[questaoAtual].id;
                const token = localStorage.getItem('token');
                
                // Carregar avalia√ß√£o do usu√°rio
                const responseUser = await fetch(`http://localhost:3002/api/avaliacoes/minha/${questaoId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (responseUser.ok) {
                    const data = await responseUser.json();
                    avaliacaoAtual = data.avaliacao;
                    if (avaliacaoAtual) {
                        avaliacaoSelecionada = avaliacaoAtual.nota;
                        atualizarEstrelas();
                        atualizarBotoesAvaliacao();
                    }
                }
                
                // Carregar estat√≠sticas
                const responseStats = await fetch(`http://localhost:3002/api/avaliacoes/estatisticas/${questaoId}`);
                if (responseStats.ok) {
                    const stats = await responseStats.json();
                    avaliacaoStats = stats;
                    renderizarEstatisticasAvaliacao();
                }
                
            } catch (error) {
                console.error('Erro ao carregar avalia√ß√£o:', error);
            }
        }

        // Renderizar estat√≠sticas de avalia√ß√£o
        function renderizarEstatisticasAvaliacao() {
            if (!avaliacaoStats) return;
            
            const container = document.getElementById('ratingStats');
            const averageRating = document.getElementById('averageRating');
            const totalRatings = document.getElementById('totalRatings');
            const ratingBars = document.getElementById('ratingBars');
            
            if (!container || !averageRating || !totalRatings || !ratingBars) return;
            
            averageRating.textContent = avaliacaoStats.mediaNota.toFixed(1);
            totalRatings.textContent = `(${avaliacaoStats.totalAvaliacoes} avalia√ß√µes)`;
            
            let barsHTML = '';
            for (let i = 5; i >= 1; i--) {
                const count = avaliacaoStats.contagemNotas[i] || 0;
                const percentual = avaliacaoStats.totalAvaliacoes > 0 ? (count / avaliacaoStats.totalAvaliacoes) * 100 : 0;
                
                barsHTML += `
                    <div class="rating-bar">
                        <span class="rating-bar-label">${i}‚òÖ</span>
                        <div class="rating-bar-bg">
                            <div class="rating-bar-fill" style="width: ${percentual}%"></div>
                        </div>
                        <span class="rating-bar-count">${count}</span>
                    </div>
                `;
            }
            
            ratingBars.innerHTML = barsHTML;
            container.style.display = 'block';
        }

        // Atualizar estrelas baseado na avalia√ß√£o selecionada
        function atualizarEstrelas() {
            const stars = document.querySelectorAll('.star');
            const ratingText = document.getElementById('ratingText');
            
            stars.forEach((star, index) => {
                const rating = index + 1;
                if (rating <= avaliacaoSelecionada) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            const textos = ['', 'Ruim', 'Regular', 'Bom', 'Muito Bom', 'Excelente'];
            ratingText.textContent = avaliacaoSelecionada > 0 ? textos[avaliacaoSelecionada] : 'Clique para avaliar';
        }

        // Atualizar bot√µes de avalia√ß√£o
        function atualizarBotoesAvaliacao() {
            const btnEnviar = document.getElementById('btnEnviarAvaliacao');
            const btnRemover = document.getElementById('btnRemoverAvaliacao');
            
            if (avaliacaoSelecionada > 0) {
                btnEnviar.style.display = 'inline-block';
                btnRemover.style.display = avaliacaoAtual ? 'inline-block' : 'none';
            } else {
                btnEnviar.style.display = 'none';
                btnRemover.style.display = 'none';
            }
        }

        // Enviar avalia√ß√£o
        async function enviarAvaliacao() {
            if (!questoes[questaoAtual] || avaliacaoSelecionada === 0) return;
            
            try {
                const questaoId = questoes[questaoAtual].id;
                const token = localStorage.getItem('token');
                
                const response = await fetch('http://localhost:3002/api/avaliacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        questao_id: questaoId,
                        nota: avaliacaoSelecionada
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao enviar avalia√ß√£o');
                }
                
                const result = await response.json();
                alert(result.message);
                
                // Recarregar avalia√ß√£o
                await carregarAvaliacao();
                
            } catch (error) {
                console.error('Erro ao enviar avalia√ß√£o:', error);
                alert('Erro ao enviar avalia√ß√£o: ' + error.message);
            }
        }

        // Remover avalia√ß√£o
        async function removerAvaliacao() {
            if (!questoes[questaoAtual]) return;
            
            if (!confirm('Tem certeza que deseja remover sua avalia√ß√£o?')) return;
            
            try {
                const questaoId = questoes[questaoAtual].id;
                const token = localStorage.getItem('token');
                
                const response = await fetch(`http://localhost:3002/api/avaliacoes/${questaoId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao remover avalia√ß√£o');
                }
                
                const result = await response.json();
                alert(result.message);
                
                // Resetar estado
                avaliacaoAtual = null;
                avaliacaoSelecionada = 0;
                atualizarEstrelas();
                atualizarBotoesAvaliacao();
                
                // Recarregar estat√≠sticas
                await carregarAvaliacao();
                
            } catch (error) {
                console.error('Erro ao remover avalia√ß√£o:', error);
                alert('Erro ao remover avalia√ß√£o: ' + error.message);
            }
        }

        // Event listeners para estrelas
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para estrelas
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    avaliacaoSelecionada = rating;
                    atualizarEstrelas();
                    atualizarBotoesAvaliacao();
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    const stars = document.querySelectorAll('.star');
                    const ratingText = document.getElementById('ratingText');
                    
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                    
                    const textos = ['', 'Ruim', 'Regular', 'Bom', 'Muito Bom', 'Excelente'];
                    ratingText.textContent = textos[rating];
                });
                
                star.addEventListener('mouseleave', function() {
                    atualizarEstrelas();
                });
            });
            
            // Event listener para contador de caracteres
            const textarea = document.getElementById('novoComentario');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    const charCount = document.getElementById('charCount');
                    if (charCount) {
                        charCount.textContent = `${this.value.length}/1000`;
                    }
                });
            }
        });

        // Inicializa√ß√£o quando o documento estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            carregarCategorias();
            carregarQuestoes();
            atualizarXP();
        });
    
</script>